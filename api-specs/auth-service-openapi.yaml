openapi: 3.0.3
info:
  title: Microservicio de Autenticación - Análisis de Gastos
  description: |
    API REST del microservicio de autenticación para la aplicación de análisis de gastos.
    
    Este microservicio es responsable de:
    - Autenticación de usuarios mediante credenciales (email/contraseña)
    - Generación y validación de tokens JWT
    - Gestión de sesiones de usuario
    
    ## Seguridad
    - Todas las comunicaciones deben realizarse mediante HTTPS en producción
    - Las contraseñas se almacenan hasheadas con algoritmos seguros (bcrypt)
    - Los tokens JWT están firmados y tienen tiempo de expiración
    - Se implementa rate limiting para prevenir ataques de fuerza bruta
    
    ## Arquitectura
    Este servicio forma parte de una arquitectura de microservicios que incluye:
    - **Autenticación** (puerto 8001): Gestión de usuarios y tokens
    - **Recopilación de Datos** (puerto 8002): Almacenamiento de gastos
    - **Manipulación de Datos** (puerto 8003): Análisis y procesamiento
  version: 1.0.0
  contact:
    name: Equipo de Desarrollo
    email: dev@analisis-gastos.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8001
    description: Servidor de desarrollo local
  - url: https://staging-auth.analisis-gastos.com
    description: Servidor de staging
  - url: https://auth.analisis-gastos.com
    description: Servidor de producción

tags:
  - name: Health
    description: Endpoints de verificación de salud del servicio
  - name: Autenticación
    description: Endpoints para autenticación y gestión de sesiones
  - name: Usuarios
    description: Endpoints para gestión de usuarios (futuro)

paths:
  /api/v1/health:
    get:
      tags:
        - Health
      summary: Verificación de salud del servicio
      description: |
        Endpoint público para verificar el estado de salud del microservicio de autenticación.
        
        **Caso de Uso:** 02-Health-Check
        
        Este endpoint es utilizado por:
        - Sistemas de monitoreo (Prometheus, Grafana)
        - Orquestadores de contenedores (Kubernetes liveness/readiness probes)
        - Balanceadores de carga
        - Equipos de DevOps
        
        **Características:**
        - No requiere autenticación
        - Respuesta rápida (< 100ms)
        - Verifica dependencias críticas (base de datos)
        
        **Estados posibles:**
        - `healthy`: Servicio funcionando correctamente
        - `degraded`: Servicio funcionando con limitaciones
        - `unhealthy`: Servicio con fallos críticos
        - `starting`: Servicio en proceso de inicialización
      operationId: healthCheck
      responses:
        '200':
          description: Servicio saludable o degradado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Servicio saludable
                  value:
                    status: healthy
                    service: auth-service
                    version: 1.0.0
                    timestamp: "2025-12-30T10:30:00Z"
                    uptime: 86400
                    checks:
                      database:
                        status: healthy
                        response_time_ms: 15
                degraded:
                  summary: Servicio degradado
                  value:
                    status: degraded
                    service: auth-service
                    version: 1.0.0
                    timestamp: "2025-12-30T10:30:00Z"
                    uptime: 86400
                    checks:
                      database:
                        status: healthy
                        response_time_ms: 12
                      redis:
                        status: unhealthy
                        response_time_ms: null
                        error: "Connection timeout"
        '503':
          description: Servicio no saludable o iniciándose
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                unhealthy:
                  summary: Servicio no saludable
                  value:
                    status: unhealthy
                    service: auth-service
                    version: 1.0.0
                    timestamp: "2025-12-30T10:30:00Z"
                    uptime: 86400
                    checks:
                      database:
                        status: unhealthy
                        response_time_ms: null
                        error: "Connection refused"
                starting:
                  summary: Servicio iniciándose
                  value:
                    status: starting
                    service: auth-service
                    version: 1.0.0
                    timestamp: "2025-12-30T10:30:00Z"
                    uptime: 5
                    checks:
                      database:
                        status: connecting
                        response_time_ms: null

  /api/v1/auth/login:
    post:
      tags:
        - Autenticación
      summary: Iniciar sesión
      description: |
        Autentica a un usuario mediante email y contraseña, y devuelve un token JWT para futuras peticiones.
        
        **Caso de Uso:** 01-Login
        
        **Flujo:**
        1. El cliente envía las credenciales del usuario
        2. El servidor valida el formato de los datos
        3. Se busca el usuario en la base de datos
        4. Se verifica la contraseña contra el hash almacenado
        5. Se genera un token JWT con la información del usuario
        6. Se devuelve el token y los datos básicos del usuario
        
        **Limitaciones:**
        - Máximo 5 intentos por minuto desde la misma IP
        - Máximo 20 intentos por hora desde la misma IP
      operationId: login
      requestBody:
        description: Credenciales del usuario para autenticación
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              valid:
                summary: Credenciales válidas
                value:
                  email: usuario@ejemplo.com
                  password: contraseña_segura123
              withSpecialChars:
                summary: Email con caracteres especiales
                value:
                  email: usuario.nombre+tag@ejemplo.com
                  password: P@ssw0rd!2024
      responses:
        '200':
          description: Login exitoso
          headers:
            X-RateLimit-Limit:
              description: Número máximo de peticiones permitidas por ventana de tiempo
              schema:
                type: integer
                example: 5
            X-RateLimit-Remaining:
              description: Número de peticiones restantes en la ventana actual
              schema:
                type: integer
                example: 4
            X-RateLimit-Reset:
              description: Timestamp cuando se reinicia el contador de rate limit
              schema:
                type: integer
                example: 1704038400
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginSuccessResponse'
              examples:
                successfulLogin:
                  summary: Login exitoso
                  value:
                    success: true
                    message: Login exitoso
                    data:
                      token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAiLCJlbWFpbCI6InVzdWFyaW9AZWplbXBsby5jb20iLCJpYXQiOjE3MDQwMzQ4MDAsImV4cCI6MTcwNDAzODQwMH0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
                      token_type: Bearer
                      expires_in: 3600
                      user:
                        id: 123e4567-e89b-12d3-a456-426614174000
                        email: usuario@ejemplo.com
                        name: Nombre Usuario
        '400':
          description: Solicitud incorrecta - Datos faltantes o formato inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                missingEmail:
                  summary: Email faltante
                  value:
                    success: false
                    message: Datos incompletos
                    errors:
                      email:
                        - El campo email es requerido
                    error_code: VALIDATION_ERROR
                missingPassword:
                  summary: Contraseña faltante
                  value:
                    success: false
                    message: Datos incompletos
                    errors:
                      password:
                        - El campo password es requerido
                    error_code: VALIDATION_ERROR
                missingBoth:
                  summary: Ambos campos faltantes
                  value:
                    success: false
                    message: Datos incompletos
                    errors:
                      email:
                        - El campo email es requerido
                      password:
                        - El campo password es requerido
                    error_code: VALIDATION_ERROR
                invalidEmailFormat:
                  summary: Formato de email inválido
                  value:
                    success: false
                    message: Datos inválidos
                    errors:
                      email:
                        - El email debe tener un formato válido
                    error_code: VALIDATION_ERROR
        '401':
          description: No autorizado - Credenciales inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidCredentials:
                  summary: Credenciales incorrectas
                  value:
                    success: false
                    message: Credenciales inválidas
                    error_code: INVALID_CREDENTIALS
        '403':
          description: Prohibido - Cuenta bloqueada o inactiva
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                accountDisabled:
                  summary: Cuenta desactivada
                  value:
                    success: false
                    message: Cuenta bloqueada o inactiva
                    error_code: ACCOUNT_DISABLED
        '429':
          description: Demasiadas peticiones - Rate limit excedido
          headers:
            X-RateLimit-Limit:
              description: Número máximo de peticiones permitidas
              schema:
                type: integer
                example: 5
            X-RateLimit-Remaining:
              description: Número de peticiones restantes (0 cuando se alcanza el límite)
              schema:
                type: integer
                example: 0
            X-RateLimit-Reset:
              description: Timestamp cuando se podrá volver a intentar
              schema:
                type: integer
                example: 1704038460
            Retry-After:
              description: Segundos que debe esperar antes de reintentar
              schema:
                type: integer
                example: 60
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimitExceeded:
                  summary: Límite de peticiones excedido
                  value:
                    success: false
                    message: Demasiados intentos de login. Por favor, intente más tarde.
                    error_code: RATE_LIMIT_EXCEEDED
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                serverError:
                  summary: Error del servidor
                  value:
                    success: false
                    message: Error interno del servidor
                    error_code: INTERNAL_SERVER_ERROR
        '503':
          description: Servicio no disponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                serviceUnavailable:
                  summary: Servicio no disponible
                  value:
                    success: false
                    message: Servicio temporalmente no disponible
                    error_code: SERVICE_UNAVAILABLE

  /api/v1/auth/logout:
    post:
      tags:
        - Autenticación
      summary: Cerrar sesión (Futuro)
      description: |
        Invalida el token JWT actual del usuario.
        
        **Estado:** Pendiente de implementación
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout exitoso
        '401':
          description: Token inválido o expirado

  /api/v1/auth/refresh:
    post:
      tags:
        - Autenticación
      summary: Renovar token (Futuro)
      description: |
        Genera un nuevo token JWT usando un refresh token.
        
        **Estado:** Pendiente de implementación
      operationId: refreshToken
      responses:
        '200':
          description: Token renovado exitosamente
        '401':
          description: Refresh token inválido

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
        - version
        - timestamp
        - uptime
        - checks
      properties:
        status:
          type: string
          description: Estado general del servicio
          enum:
            - healthy
            - degraded
            - unhealthy
            - starting
          example: healthy
        service:
          type: string
          description: Nombre del microservicio
          example: auth-service
        version:
          type: string
          description: Versión del servicio (formato semántico)
          pattern: '^\d+\.\d+\.\d+$'
          example: 1.0.0
        timestamp:
          type: string
          format: date-time
          description: Marca de tiempo de la verificación (ISO 8601)
          example: "2025-12-30T10:30:00Z"
        uptime:
          type: integer
          description: Tiempo en segundos desde que el servicio inició
          minimum: 0
          example: 86400
        checks:
          type: object
          description: Mapa de verificaciones de dependencias
          additionalProperties:
            $ref: '#/components/schemas/HealthCheck'
          example:
            database:
              status: healthy
              response_time_ms: 15

    HealthCheck:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Estado de la dependencia
          enum:
            - healthy
            - degraded
            - unhealthy
            - connecting
          example: healthy
        response_time_ms:
          type: integer
          description: Tiempo de respuesta en milisegundos (null si no disponible)
          nullable: true
          example: 15
        error:
          type: string
          description: Mensaje de error (solo presente cuando hay problemas)
          example: "Connection timeout"

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          maxLength: 255
          description: Email del usuario registrado en el sistema
          example: usuario@ejemplo.com
        password:
          type: string
          format: password
          minLength: 8
          description: Contraseña del usuario (mínimo 8 caracteres)
          example: contraseña_segura123

    LoginSuccessResponse:
      type: object
      required:
        - success
        - message
        - data
      properties:
        success:
          type: boolean
          description: Indica si la operación fue exitosa
          example: true
        message:
          type: string
          description: Mensaje descriptivo del resultado
          example: Login exitoso
        data:
          type: object
          required:
            - token
            - token_type
            - expires_in
            - user
          properties:
            token:
              type: string
              description: Token JWT para autenticar futuras peticiones
              example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
            token_type:
              type: string
              description: Tipo de token (siempre "Bearer")
              enum: [Bearer]
              example: Bearer
            expires_in:
              type: integer
              description: Tiempo de expiración del token en segundos
              example: 3600
            user:
              $ref: '#/components/schemas/User'

    User:
      type: object
      required:
        - id
        - email
        - name
      properties:
        id:
          type: string
          format: uuid
          description: Identificador único del usuario
          example: 123e4567-e89b-12d3-a456-426614174000
        email:
          type: string
          format: email
          description: Email del usuario
          example: usuario@ejemplo.com
        name:
          type: string
          description: Nombre completo del usuario
          example: Nombre Usuario

    ErrorResponse:
      type: object
      required:
        - success
        - message
        - error_code
      properties:
        success:
          type: boolean
          description: Indica si la operación fue exitosa (siempre false en errores)
          example: false
        message:
          type: string
          description: Mensaje descriptivo del error
          example: Credenciales inválidas
        error_code:
          type: string
          description: Código único del error para identificación programática
          example: INVALID_CREDENTIALS
          enum:
            - INVALID_CREDENTIALS
            - ACCOUNT_DISABLED
            - VALIDATION_ERROR
            - RATE_LIMIT_EXCEEDED
            - INTERNAL_SERVER_ERROR
            - SERVICE_UNAVAILABLE

    ValidationErrorResponse:
      type: object
      required:
        - success
        - message
        - errors
        - error_code
      properties:
        success:
          type: boolean
          description: Indica si la operación fue exitosa (siempre false)
          example: false
        message:
          type: string
          description: Mensaje general del error
          example: Datos incompletos
        errors:
          type: object
          description: Objeto con los errores de validación por campo
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - El campo email es requerido
            password:
              - El campo password es requerido
        error_code:
          type: string
          description: Código del error (siempre VALIDATION_ERROR para errores de validación)
          example: VALIDATION_ERROR

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Token JWT obtenido del endpoint de login.
        
        **Uso:**
        ```
        Authorization: Bearer <token>
        ```

security: []
